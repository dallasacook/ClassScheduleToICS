/**
 * Class schedule to .ics file bookmarklet
 * Leo Koppel
 * Rewritten from the script by Keanu Lee (https://github.com/keanulee/ClassScheduleToICS) */
function time_to_seconds(e){return m=e.match(/(\d*):(\d*)(\wM)/),hour=parseInt(m[1]),min=parseInt(m[2]),"PM"==m[3]&&(hour+=12),60*(60*hour+min)}function pad(e){return 10>e?"0"+e:e}function date_to_string(e){return e.getFullYear()+pad(e.getMonth()+1)+pad(e.getDate())+"T"+pad(e.getHours())+pad(e.getMinutes())+pad(e.getSeconds())+"Z"}function title_case(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function create_ics_wrap(e){return ics_content="BEGIN:VCALENDAR\r\nPRODID:-//Leo Koppel//Queen's Soulless Calendar Exporter//EN\r\nVERSION:2.0\r\nBEGIN:VTIMEZONE\r\nTZID:America/New_York\r\nX-LIC-LOCATION:America/New_York\r\nBEGIN:DAYLIGHT\r\nTZOFFSETFROM:-0500\r\nTZOFFSETTO:-0400\r\nTZNAME:EDT\r\nDTSTART:19700308T020000\r\nRRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=2SU\r\nEND:DAYLIGHT\r\nBEGIN:STANDARD\r\nTZOFFSETFROM:-0400\r\nTZOFFSETTO:-0500\r\nTZNAME:EST\r\nDTSTART:19701101T020000\r\nRRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU\r\nEND:STANDARD\r\nEND:VTIMEZONE\r\n",ics_content+=e.join("\r\n"),ics_content+="END:VCALENDAR\r\n"}function create_ics(){if(ics_events=[],0==$(".PSGROUPBOXWBO").length)throw"Course tables not found.";if(frame.$(".PSGROUPBOXWBO:gt(0)").each(function(){_course_title_parts=$(this).find("td:eq(0)").text().split("-"),course_code=_course_title_parts[0],course_name=_course_title_parts[1],$(this).find("tr:gt(7)").each(function(){cells=$(this).find("td").map(function(){return $(this).text()}),0!=cells[3].trim().length&&(component=cells[2].trim(),days_and_times=cells[3].split(" "),room=cells[4].trim(),instructor=cells[5].trim(),start_and_end=cells[6].split(" - "),input_weekday=days_and_times[0].trim(),input_start_time=days_and_times[1].trim(),input_end_time=days_and_times[3].trim(),range_start_date=new Date(Date.parse(start_and_end[0])),range_end_date=new Date(Date.parse(start_and_end[1])),range_end_date.setTime(range_end_date.getTime()+864e5),start_day=weekdays_input.indexOf(input_weekday),range_start_day=range_start_date.getDay(),incr=(7-range_start_day+start_day)%7,start_date=new Date(range_start_date.getTime()+864e5*incr+1e3*time_to_seconds(input_start_time)),end_date=new Date(range_start_date.getTime()+864e5*incr+1e3*time_to_seconds(input_end_time)),ics_events.push("BEGIN:VEVENT\r\nDTSTART;TZID=America/New_York:"+date_to_string(start_date)+"\r\nDTEND;TZID=America/New_York:"+date_to_string(end_date)+"\r\nSUMMARY:"+course_code+" "+component+"\r\nLOCATION:"+title_case(room)+"\r\nDESCRIPTION:"+course_code+" - "+course_name+" "+component+". "+instructor+"\r\nRRULE:FREQ=WEEKLY;UNTIL="+date_to_string(range_end_date)+"\r\nEND:VEVENT\r\n"))})}),0==ics_events.length)throw"No class entries found.";return create_ics_wrap(ics_events)}var ver="0.1",frame=parent.TargetContent,weekdays_input=["Su","Mo","Tu","We","Th","Fr","Sa"];try{!function(){function e(){(frame.CalendarBookmarklet=function(){ics_content=create_ics(),$("#ics_download").remove(),frame.$(".PATRANSACTIONTITLE").append(' <span id="ics_download">(<a href="data:text/calendar;charset=utf8,'+encodeURIComponent(ics_content)+'" download="coursecalendar.ics">Download .ics file</a>)</span>')})()}var t="1.10.0";if(void 0===frame)throw"TargetContent frame not found.";if(void 0===frame.jQuery||frame.jQuery.fn.jquery<t){var n=!1,r=frame.document.createElement("script");r.src="https://ajax.googleapis.com/ajax/libs/jquery/"+t+"/jquery.min.js",r.onload=r.onreadystatechange=function(){n||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(n=!0,e())},frame.document.getElementsByTagName("head")[0].appendChild(r)}else e()}()}catch(err){alert('It didn\'t work :(\nMake sure you are on the "List View" of " My Class Schedule".\n\nOtherwise, report this: \nv'+ver+"\n"+err)}