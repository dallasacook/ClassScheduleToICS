var ver="0.1";var frame=parent.TargetContent;var weekdays_input=["Su","Mo","Tu","We","Th","Fr","Sa"];function time_to_seconds(a){m=a.match(/(\d*):(\d*)(\wM)/);hour=parseInt(m[1]);min=parseInt(m[2]);if(m[3]=="PM"){hour+=12}return(hour*60+min)*60}function pad(a){if(a<10){return"0"+a}return a}function date_to_string(a){return a.getFullYear()+pad(a.getMonth()+1)+pad(a.getDate())+"T"+pad(a.getHours())+pad(a.getMinutes())+pad(a.getSeconds())+"Z"}function title_case(a){return a.replace(/\w\S*/g,function(b){return b.charAt(0).toUpperCase()+b.substr(1).toLowerCase()})}function create_ics_wrap(a){ics_content="BEGIN:VCALENDAR\r\nPRODID:-//Leo Koppel//Queen's Soulless Calendar Exporter//EN\r\nVERSION:2.0\r\nBEGIN:VTIMEZONE\r\nTZID:America/New_York\r\nX-LIC-LOCATION:America/New_York\r\nBEGIN:DAYLIGHT\r\nTZOFFSETFROM:-0500\r\nTZOFFSETTO:-0400\r\nTZNAME:EDT\r\nDTSTART:19700308T020000\r\nRRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=2SU\r\nEND:DAYLIGHT\r\nBEGIN:STANDARD\r\nTZOFFSETFROM:-0400\r\nTZOFFSETTO:-0500\r\nTZNAME:EST\r\nDTSTART:19701101T020000\r\nRRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU\r\nEND:STANDARD\r\nEND:VTIMEZONE\r\n";ics_content+=a.join("\r\n");ics_content+="END:VCALENDAR\r\n";return ics_content}function create_ics(){ics_events=[];if($(".PSGROUPBOXWBO").length==0){throw"Course tables not found."}frame.$(".PSGROUPBOXWBO:gt(0)").each(function(){_course_title_parts=$(this).find("td:eq(0)").text().split("-");course_code=_course_title_parts[0];course_name=_course_title_parts[1];$(this).find("tr:gt(7)").each(function(){cells=$(this).find("td").map(function(){return $(this).text()});if(cells[3].trim().length==0){return}component=cells[2].trim();days_and_times=cells[3].split(" ");room=cells[4].trim();instructor=cells[5].trim();start_and_end=cells[6].split(" - ");input_weekday=days_and_times[0].trim();input_start_time=days_and_times[1].trim();input_end_time=days_and_times[3].trim();range_start_date=new Date(Date.parse(start_and_end[0]));range_end_date=new Date(Date.parse(start_and_end[1]));range_end_date.setTime(range_end_date.getTime()+24*(60*60*1000));start_day=weekdays_input.indexOf(input_weekday);range_start_day=range_start_date.getDay();incr=(7-range_start_day+start_day)%7;start_date=new Date(range_start_date.getTime()+incr*(24*60*60*1000)+time_to_seconds(input_start_time)*1000);end_date=new Date(range_start_date.getTime()+incr*(24*60*60*1000)+time_to_seconds(input_end_time)*1000);ics_events.push("BEGIN:VEVENT\r\nDTSTART;TZID=America/New_York:"+date_to_string(start_date)+"\r\nDTEND;TZID=America/New_York:"+date_to_string(end_date)+"\r\nSUMMARY:"+course_code+" "+component+"\r\nLOCATION:"+title_case(room)+"\r\nDESCRIPTION:"+course_code+" - "+course_name+" "+component+". "+instructor+"\r\nRRULE:FREQ=WEEKLY;UNTIL="+date_to_string(range_end_date)+"\r\nEND:VEVENT\r\n")})});if(ics_events.length==0){throw"No class entries found."}return create_ics_wrap(ics_events)}try{(function(){var d="1.10.0";if(frame===undefined){throw"TargetContent frame not found."}if(frame.jQuery===undefined||frame.jQuery.fn.jquery<d){var b=false;var c=frame.document.createElement("script");c.src="https://ajax.googleapis.com/ajax/libs/jquery/"+d+"/jquery.min.js";c.onload=c.onreadystatechange=function(){if(!b&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){b=true;a()}};frame.document.getElementsByTagName("head")[0].appendChild(c)}else{a()}function a(){(frame.CalendarBookmarklet=function(){ics_content=create_ics();$("#ics_download").remove();frame.$(".PATRANSACTIONTITLE").append(' <span id="ics_download">(<a href="data:text/calendar;charset=utf8,'+encodeURIComponent(ics_content)+'" download="coursecalendar.ics">Download .ics file</a>)</span>')})()}})()}catch(err){alert('It didn\'t work :(\nMake sure you are on the "List View" of " My Class Schedule".\n\nOtherwise, report this: \nv'+ver+"\n"+err)};